package gov.ca.dcss.guidelinecalculator.rules;

import gov.ca.dcss.guidelinecalculator.model.DependentInfo;
import gov.ca.dcss.guidelinecalculator.model.Dependent;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

rule "Validate Children Count"
    when
        childrenCount: Integer(this < 0 || this > 10)
    then
        throw new RuntimeException("Number of children must be between 0 and 10");
end

rule "Validate Dependent Info - Required Fields"
    when
        $info: DependentInfo( $dependents: dependents )
        $dep: Dependent(
            dependentName == null || dependentName.trim().isEmpty() ||
            dateOfBirth == null || dateOfBirth.trim().isEmpty() ||
            relationship == null || relationship.trim().isEmpty()
        ) from $dependents
    then
        throw new RuntimeException("Dependent name, date of birth, and relationship are required fields");
end

rule "Validate Dependent Info - Date of Birth"
    when
        $info: DependentInfo( $dependents: dependents )
        $dep: Dependent( dateOfBirth != null ) from $dependents
    then
        try {
            LocalDate dob = LocalDate.parse($dep.getDateOfBirth(), DateTimeFormatter.ISO_DATE);
            LocalDate now = LocalDate.now();
            if (dob.isAfter(now)) {
                throw new RuntimeException("Date of birth cannot be in the future");
            }
            if (dob.isBefore(now.minusYears(18))) {
                throw new RuntimeException("Dependent must be under 18 years old");
            }
        } catch (Exception e) {
            throw new RuntimeException("Invalid date format. Please use YYYY-MM-DD format");
        }
end

rule "Validate Dependent Info - Overnight Percentage"
    when
        $info: DependentInfo( $dependents: dependents )
        $dep: Dependent( overnightPercentage < 0 || overnightPercentage > 100 ) from $dependents
    then
        throw new RuntimeException("Overnight percentage must be between 0 and 100");
end

rule "Validate Dependent Info - Monthly Health Premium"
    when
        $info: DependentInfo( $dependents: dependents )
        $dep: Dependent( monthlyHealthPremium < 0 ) from $dependents
    then
        throw new RuntimeException("Monthly health premium cannot be negative");
end